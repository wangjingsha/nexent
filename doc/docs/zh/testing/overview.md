# æµ‹è¯•æ¦‚è§ˆ

Nexent æä¾›äº†ä¸€ä¸ªå…¨é¢çš„æµ‹è¯•æ¡†æ¶ï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶çš„ä»£ç è´¨é‡å’Œå¯é æ€§ã€‚æœ¬æŒ‡å—æ¶µç›–äº†é¡¹ç›®ä¸­ä½¿ç”¨çš„æµ‹è¯•ç­–ç•¥ã€å·¥å…·å’Œæœ€ä½³å®è·µã€‚

## æµ‹è¯•ç†å¿µ

æˆ‘ä»¬çš„æµ‹è¯•æ–¹æ³•å»ºç«‹åœ¨å››ä¸ªæ ¸å¿ƒåŸåˆ™ä¹‹ä¸Šï¼š

1. **éš”ç¦»å•å…ƒ**ï¼šæ¨¡æ‹Ÿæ‰€æœ‰å¤–éƒ¨ä¾èµ–
2. **æ§åˆ¶ç¯å¢ƒ**ï¼šè®¾ç½®ç²¾ç¡®çš„æµ‹è¯•æ¡ä»¶
3. **æµ‹è¯•æ¥å£**ï¼šä¸“æ³¨äºè¾“å…¥å’Œè¾“å‡º
4. **éªŒè¯è¡Œä¸º**ï¼šæ£€æŸ¥ç»“æœå’Œäº¤äº’

è¿™ç¡®ä¿äº†æµ‹è¯•çš„å¯é æ€§ã€å¿«é€Ÿæ€§ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“çœŸå®çš„ç³»ç»Ÿæˆ–æ•°æ®ã€‚

## æµ‹è¯•æ¡†æ¶

é¡¹ç›®ä½¿ç”¨å¤šç§æµ‹è¯•æ¡†æ¶çš„ç»„åˆï¼š

- **unittest**ï¼šPython æ ‡å‡†å•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œç”¨äºæµ‹è¯•ç»„ç»‡å’Œæ–­è¨€
- **unittest.mock**ï¼šç”¨äºæ¨¡æ‹Ÿä¾èµ–é¡¹å’Œéš”ç¦»ç»„ä»¶
- **TestClient** from FastAPIï¼šç”¨äºæµ‹è¯• API ç«¯ç‚¹è€Œæ— éœ€è¿è¡Œå®é™…æœåŠ¡å™¨
- **pytest**ï¼šç”¨äºé«˜çº§æµ‹è¯•å‘ç°å’Œæ‰§è¡Œ
- **coverage**ï¼šç”¨äºä»£ç è¦†ç›–ç‡åˆ†æå’ŒæŠ¥å‘Š

## æµ‹è¯•ç»“æ„

```
test/
â”œâ”€â”€ backend/                 # åç«¯æµ‹è¯•
â”‚   â”œâ”€â”€ app/                # API ç«¯ç‚¹æµ‹è¯•
â”‚   â”œâ”€â”€ services/           # æœåŠ¡å±‚æµ‹è¯•
â”‚   â””â”€â”€ utils/              # å·¥å…·å‡½æ•°æµ‹è¯•
â”œâ”€â”€ frontend/               # å‰ç«¯æµ‹è¯•ï¼ˆæœªæ¥ï¼‰
â”œâ”€â”€ integration/            # é›†æˆæµ‹è¯•ï¼ˆæœªæ¥ï¼‰
â””â”€â”€ run_all_tests.py       # ä¸»æµ‹è¯•è¿è¡Œå™¨
```

## ä¸»è¦ç‰¹æ€§

- ğŸ” **è‡ªåŠ¨å‘ç°æµ‹è¯•æ–‡ä»¶** - è‡ªåŠ¨æŸ¥æ‰¾æ‰€æœ‰ `test_*.py` æ–‡ä»¶
- ğŸ“Š **è¦†ç›–ç‡æŠ¥å‘Š** - ç”Ÿæˆæ§åˆ¶å°ã€HTML å’Œ XML æ ¼å¼çš„è¦†ç›–ç‡æŠ¥å‘Š
- ğŸ”§ **è‡ªåŠ¨å®‰è£…ä¾èµ–** - è‡ªåŠ¨å®‰è£…æ‰€éœ€çš„åŒ…ï¼ˆå¦‚æœéœ€è¦ï¼‰
- âœ… **è¯¦ç»†è¾“å‡º** - æ˜¾ç¤ºæ¯ä¸ªæµ‹è¯•çš„è¿è¡ŒçŠ¶æ€å’Œç»“æœ
- ğŸš« **å®Œå…¨éš”ç¦»** - ä»ä¸æ¥è§¦çœŸå®çš„å¤–éƒ¨æœåŠ¡
- âš¡ **å¿«é€Ÿæ‰§è¡Œ** - æ— ç½‘ç»œå»¶è¿Ÿæˆ–å¤–éƒ¨æœåŠ¡å¤„ç†æ—¶é—´

## è¿è¡Œæµ‹è¯•

### å¿«é€Ÿå¼€å§‹

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
cd test
python run_all_tests.py
```

### åç«¯æµ‹è¯•

```bash
# ä»…è¿è¡Œåç«¯æµ‹è¯•
python test/backend/run_all_test.py
```

### å•ä¸ªæµ‹è¯•æ–‡ä»¶

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
python -m pytest test/backend/services/test_agent_service.py -v
```

## è¾“å‡ºæ–‡ä»¶

æµ‹è¯•å®Œæˆåï¼Œæ‚¨å°†æ‰¾åˆ°ï¼š

- `coverage_html/` - è¯¦ç»†çš„ HTML æ ¼å¼è¦†ç›–ç‡æŠ¥å‘Š
- `coverage.xml` - XML æ ¼å¼è¦†ç›–ç‡æŠ¥å‘Šï¼ˆç”¨äº CI/CDï¼‰
- `.coverage` - è¦†ç›–ç‡æ•°æ®æ–‡ä»¶
- åŒ…å«è¯¦ç»†æµ‹è¯•ç»“æœå’Œè¦†ç›–ç‡ç»Ÿè®¡çš„æ§åˆ¶å°è¾“å‡º

## æµ‹è¯•ç­–ç•¥

### 1. ä¾èµ–éš”ç¦»

åœ¨å¯¼å…¥ä¹‹å‰æ¨¡æ‹Ÿå¤–éƒ¨æ¨¡å—ä»¥é¿å…çœŸå®è¿æ¥ï¼š

- æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥
- æ¨¡æ‹Ÿ ElasticSearch å’Œå…¶ä»–å¤–éƒ¨æœåŠ¡
- æµ‹è¯•æœŸé—´ä¸æ‰§è¡Œå®é™…çš„æ•°æ®åº“æ“ä½œ
- æ¨¡æ‹Ÿ HTTP å®¢æˆ·ç«¯ä»¥é˜²æ­¢ç½‘ç»œè°ƒç”¨

### 2. åŸºäºæ¨¡æ‹Ÿçš„æµ‹è¯•

- ä½¿ç”¨ FastAPI çš„ TestClient æ¨¡æ‹Ÿ HTTP è¯·æ±‚
- ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡æ‹¦æˆªå¤–éƒ¨æœåŠ¡è°ƒç”¨
- ä¸å‘ç”Ÿå®é™…çš„ç½‘ç»œè¿æ¥æˆ–ç«¯å£ç»‘å®š
- æ¨¡æ‹Ÿèº«ä»½éªŒè¯å‡½æ•°ä»¥è¿”å›å¯é¢„æµ‹çš„æµ‹è¯•å€¼

### 3. æµ‹è¯•ç»„ç»‡

- æµ‹è¯•ç»„ç»‡ä¸ºç»§æ‰¿è‡ª `unittest.TestCase` çš„ç±»
- æ¯ä¸ª API ç«¯ç‚¹æˆ–å‡½æ•°éƒ½æœ‰å¤šä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆæˆåŠŸã€å¤±è´¥ã€å¼‚å¸¸åœºæ™¯ï¼‰
- åº”ç”¨å…¨é¢çš„è¡¥ä¸æ¥éš”ç¦»è¢«æµ‹è¯•çš„ä»£ç 
- æµ‹è¯•éµå¾ªæ¸…æ™°çš„è®¾ç½®-æ‰§è¡Œ-æ–­è¨€æ¨¡å¼

### 4. API æµ‹è¯•

- æµ‹è¯• API ç«¯ç‚¹çš„æ­£ç¡®å“åº”ä»£ç ã€è´Ÿè½½ç»“æ„å’Œé”™è¯¯å¤„ç†
- æ¶µç›–åŒæ­¥å’Œå¼‚æ­¥ç«¯ç‚¹
- é€šè¿‡ä¸“é—¨çš„æµ‹è¯•ç”¨ä¾‹æµ‹è¯•æµå¼å“åº”
- å½»åº•æµ‹è¯•èº«ä»½éªŒè¯å’Œæˆæƒ

## æ¨¡å—è¡¥ä¸æŠ€æœ¯

æµ‹è¯•å¥—ä»¶ä¸­ä½¿ç”¨çš„å…³é”®æŠ€æœ¯æ˜¯åœ¨å¯¼å…¥ä¹‹å‰ä¿®è¡¥æ¨¡å—ã€‚è¿™å¯ä»¥é˜²æ­¢ä»»ä½•çœŸå®çš„å¤–éƒ¨æœåŠ¡è¿æ¥ã€‚

### ç¤ºä¾‹ï¼šå¯¼å…¥å‰è¡¥ä¸

```python
# åŠ¨æ€ç¡®å®šåç«¯è·¯å¾„
current_dir = os.path.dirname(os.path.abspath(__file__))
backend_dir = os.path.abspath(os.path.join(current_dir, "../../../backend"))
sys.path.append(backend_dir)

# åœ¨å¯¼å…¥æ¨¡å—ä¹‹å‰è®¾ç½®ä¾èµ–é¡¹è¡¥ä¸
patches = [
    patch('botocore.client.BaseClient._make_api_call', return_value={}),
    patch('backend.database.client.MinioClient', MagicMock()),
    patch('backend.database.client.db_client', MagicMock()),
    patch('backend.utils.auth_utils.get_current_user_id', 
          MagicMock(return_value=('test_user', 'test_tenant'))),
    patch('httpx.AsyncClient', MagicMock())
]

# å¯åŠ¨æ‰€æœ‰è¡¥ä¸
for p in patches:
    p.start()

# ç°åœ¨åœ¨åº”ç”¨æ‰€æœ‰è¡¥ä¸åå¯¼å…¥æ¨¡å—
from backend.apps.file_management_app import router
```

### è¿™ç§æ–¹æ³•çš„ä¼˜åŠ¿

1. **å®Œå…¨éš”ç¦»**ï¼šä»ä¸æ¥è§¦çœŸå®çš„å¤–éƒ¨æœåŠ¡
2. **æ— å‰¯ä½œç”¨**ï¼šæµ‹è¯•æ— æ³•ä¿®æ”¹ç”Ÿäº§æ•°æ®åº“æˆ–æœåŠ¡
3. **æ›´å¿«çš„æµ‹è¯•**ï¼šæ— ç½‘ç»œå»¶è¿Ÿæˆ–å¤–éƒ¨æœåŠ¡å¤„ç†æ—¶é—´
4. **å¯é¢„æµ‹çš„ç»“æœ**ï¼šæµ‹è¯•ä½¿ç”¨å—æ§çš„æ¨¡æ‹Ÿæ•°æ®ä»¥è·å¾—ä¸€è‡´çš„ç»“æœ
5. **æ— ç«¯å£ç»‘å®š**ï¼šFastAPI åº”ç”¨ç¨‹åºä»ä¸ç»‘å®šåˆ°çœŸå®çš„ç½‘ç»œç«¯å£

## æµ‹è¯•ç¤ºä¾‹

ä»¥ä¸‹æ˜¯æµ‹è¯•ç»“æ„åŒ–çš„è¯¦ç»†ç¤ºä¾‹ï¼š

```python
@patch("utils.auth_utils.get_current_user_id")
@patch("database.agent_db.query_all_tools")
async def test_list_tools_api_success(self, mock_query_all_tools, mock_get_current_user_id):
    # è®¾ç½®
    mock_get_current_user_id.return_value = ("user123", "tenant456")
    expected_tools = [{"id": 1, "name": "Tool1"}, {"id": 2, "name": "Tool2"}]
    mock_query_all_tools.return_value = expected_tools
    
    # æ‰§è¡Œ
    result = await list_tools_api(authorization="Bearer fake_token")
    
    # æ–­è¨€
    mock_get_current_user_id.assert_called_once_with("Bearer fake_token")
    mock_query_all_tools.assert_called_once_with(tenant_id="tenant456")
    self.assertEqual(result, expected_tools)
```

## è¦†ç›–ç‡æŠ¥å‘Š

æµ‹è¯•å¥—ä»¶ç”Ÿæˆå…¨é¢çš„è¦†ç›–ç‡æŠ¥å‘Šï¼š

- **æ§åˆ¶å°è¾“å‡º**ï¼šé€è¡Œè¦†ç›–ç‡è¯¦ç»†ä¿¡æ¯
- **HTML æŠ¥å‘Š**ï¼š`coverage_html/` ä¸­çš„è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
- **XML æŠ¥å‘Š**ï¼šç”¨äº CI/CD é›†æˆçš„è¦†ç›–ç‡æ•°æ®
- **æ‘˜è¦ç»Ÿè®¡**ï¼šæ€»ä½“è¦†ç›–ç‡ç™¾åˆ†æ¯”å’Œç¼ºå¤±è¡Œ

## ç¤ºä¾‹è¾“å‡º

```
Nexent Community - Unit Test Runner
============================================================
å‘ç°çš„æµ‹è¯•æ–‡ä»¶ï¼š
----------------------------------------
  â€¢ backend/services/test_agent_service.py
  â€¢ backend/services/test_conversation_management_service.py
  â€¢ backend/services/test_knowledge_summary_service.py

æ€»è®¡ï¼š3 ä¸ªæµ‹è¯•æ–‡ä»¶

============================================================
è¿è¡Œå•å…ƒæµ‹è¯•å’Œè¦†ç›–ç‡
============================================================

test_get_enable_tool_id_by_agent_id ... ok
test_save_message_with_string_content ... ok
test_load_knowledge_prompts ... ok
...

============================================================
è¦†ç›–ç‡æŠ¥å‘Š
============================================================
åç§°                                               Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------
backend/services/agent_service.py                   120     15    88%   45-50, 78-82
backend/services/conversation_management_service.py  180     25    86%   123-128, 156-162
backend/services/knowledge_summary_service.py        45      8    82%   35-42
--------------------------------------------------------------------------------
æ€»è®¡                                               345     48    86%

HTML è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆåœ¨ï¼štest/coverage_html
XML è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆï¼štest/coverage.xml

============================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

## ä¾èµ–é¡¹

æµ‹è¯•è¿è¡Œå™¨ä¼šè‡ªåŠ¨å®‰è£…æ‰€éœ€çš„åŒ…ï¼ˆå¦‚æœå°šæœªå¯ç”¨ï¼‰ï¼š

- `pytest-cov` - ç”¨äº pytest è¦†ç›–ç‡é›†æˆ
- `coverage` - ç”¨äºä»£ç è¦†ç›–ç‡åˆ†æ
- `pytest` - ç”¨äºé«˜çº§æµ‹è¯•å‘ç°å’Œæ‰§è¡Œ

## æœ€ä½³å®è·µ

1. **å§‹ç»ˆåœ¨å¯¼å…¥æ¨¡å—ä¹‹å‰æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–**
2. **ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°**æ¥è§£é‡Šæ­£åœ¨æµ‹è¯•çš„å†…å®¹
3. **éµå¾ªè®¾ç½®-æ‰§è¡Œ-æ–­è¨€æ¨¡å¼**ä»¥è·å¾—æ¸…æ™°çš„æµ‹è¯•ç»“æ„
4. **æµ‹è¯•æˆåŠŸå’Œå¤±è´¥åœºæ™¯**ä»¥è·å¾—å…¨é¢çš„è¦†ç›–ç‡
5. **ä¿æŒæµ‹è¯•ç‹¬ç«‹** - æ¯ä¸ªæµ‹è¯•éƒ½åº”è¯¥èƒ½å¤Ÿç‹¬ç«‹è¿è¡Œ
6. **ä½¿ç”¨æœ‰æ„ä¹‰çš„æ¨¡æ‹Ÿæ•°æ®**æ¥ä»£è¡¨çœŸå®ä¸–ç•Œçš„åœºæ™¯
7. **ç”¨æ¸…æ™°çš„æ³¨é‡Šè®°å½•å¤æ‚çš„æµ‹è¯•åœºæ™¯**

è¿™ä¸ªæµ‹è¯•æ¡†æ¶ç¡®ä¿æ‰€æœ‰ä»£ç æ›´æ”¹åœ¨éƒ¨ç½²å‰éƒ½ç»è¿‡å½»åº•éªŒè¯ï¼Œåœ¨æ•´ä¸ª Nexent å¹³å°ä¸­ä¿æŒé«˜ä»£ç è´¨é‡å’Œå¯é æ€§ã€‚ 